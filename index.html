<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Aplikasi Pengecekan & Pembersihan PIB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #eaf6ef;
    }
    .header {
        background: #2eb872;
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 22px;
        font-weight: bold;
    }
    .tabs {
        margin: 20px auto;
        text-align: center;
    }
    .tabs button {
        padding: 12px 22px;
        margin: 5px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        background: #c2ecd3;
    }
    .tabs button.active {
        background: #2eb872;
        color: white;
    }
    .container {
        max-width: 900px;
        margin: 25px auto;
        padding: 25px;
        background: white;
        border-radius: 18px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.12);
    }
    .file-group {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
    }
    .file-card {
        flex: 1;
        margin: 10px;
        padding: 20px;
        background: #effdf4;
        border-radius: 14px;
        border: 2px dashed #8fdab3;
        text-align: center;
        cursor: pointer;
    }
    input[type="file"] { display: none; }

    .button {
        display: block;
        width: 240px;
        margin: 20px auto;
        padding: 13px;
        background: #2eb872;
        color: white;
        border-radius: 12px;
        font-size: 16px;
        cursor: pointer;
        border: none;
    }
    .button:hover { background: #239e63; }

    .result-box {
        margin-top: 20px;
        padding: 20px;
        background: #e8fff1;
        border-left: 6px solid #2eb872;
        border-radius: 10px;
        display: none;
    }

    .alert {
        position: fixed;
        left: 50%;
        top: 40%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px 30px;
        border-radius: 16px;
        box-shadow: 0 8px 22px rgba(0,0,0,0.3);
        font-size: 18px;
        display: none;
        z-index: 9999;
    }
    .alert button {
        margin-top: 12px;
        background: #ff3b30;
        color: white;
        padding: 8px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
    }
</style>
</head>

<body>

<div class="header">Aplikasi Pengecekan & Pembersihan PIB</div>

<div class="tabs">
    <button class="active" onclick="showTab('compare')">Perbandingan Data</button>
    <button onclick="showTab('clean')">Pembersih Petik PIB</button>
</div>

<!-- TAB PERBANDINGAN -->
<div id="compare" class="container">
    <h2>Perbandingan Data Lama vs Baru</h2>

    <div class="file-group">
        <label class="file-card">
            <strong>Upload Data Lama</strong><br>
            <span id="labelLama">Belum ada file</span>
            <input type="file" id="fileLama" accept=".xlsx">
        </label>

        <label class="file-card">
            <strong>Upload Data Baru</strong><br>
            <span id="labelBaru">Belum ada file</span>
            <input type="file" id="fileBaru" accept=".xlsx">
        </label>
    </div>

    <button class="button" onclick="processComparison()">Proses Perbandingan</button>

    <div id="resultCompare" class="result-box"></div>
</div>

<!-- TAB CLEANER -->
<div id="clean" class="container" style="display:none">
    <h2>Pembersih Petik (') di Kolom PIB</h2>

    <div class="file-group">
        <label class="file-card">
            <strong>Upload File Excel</strong><br>
            <span id="labelClean">Belum ada file</span>
            <input type="file" id="fileClean" accept=".xlsx">
        </label>
    </div>

    <button class="button" onclick="processCleaner()">Bersihkan Petik PIB</button>

    <div id="resultClean" class="result-box"></div>
</div>

<!-- ALERT -->
<div id="alertBox" class="alert">
    <span id="alertMessage"></span><br>
    <button onclick="closeAlert()">Tutup</button>
</div>

<script>

/* =======================
   HELPER FUNCTIONS
======================= */

function showTab(tab) {
    document.getElementById("compare").style.display = tab === "compare" ? "block" : "none";
    document.getElementById("clean").style.display = tab === "clean" ? "block" : "none";

    document.querySelectorAll(".tabs button").forEach(btn => btn.classList.remove("active"));
    event.target.classList.add("active");
}

function alertMsg(msg) {
    document.getElementById("alertMessage").innerText = msg;
    document.getElementById("alertBox").style.display = "block";
}
function closeAlert() { document.getElementById("alertBox").style.display = "none"; }

function cleanPIB(x) {
    return String(x || "")
        .replace(/^'/, "")
        .replace(/"/g, "")
        .trim();
}

/* =======================
   FIX PENTING: BACA BPOM
   (RAW MODE seperti pandas)
======================= */

async function readExcel(file) {
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);

    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    // Baca semua baris mentah (tidak menghapus baris kosong)
    const raw = XLSX.utils.sheet_to_json(sheet, {
        header: 1,
        blankrows: true,
        defval: ""
    });

    // Cari baris header "NO. PIB"
    let headerRow = -1;
    for (let i = 0; i < raw.length; i++) {
        const row = raw[i].map(x => String(x).toUpperCase());
        if (row.some(col => col.includes("NO. PIB"))) {
            headerRow = i;
            break;
        }
    }

    if (headerRow === -1) {
        alertMsg("Kolom 'NO. PIB' tidak ditemukan! (header BPOM tidak terbaca)");
        return null;
    }

    return XLSX.utils.sheet_to_json(sheet, { range: headerRow, defval: "" });
}

/* =======================
   DETEKSI KOLOM PIB OTOMATIS
======================= */

function detectKolomPIB(row) {
    const keys = Object.keys(row);

    for (let k of keys) {
        const n = k.toUpperCase().replace(/[^A-Z0-9]/g, "");
        if (n.includes("NOPIB") || (n.includes("NO") && n.includes("PIB"))) {
            return k;
        }
    }

    // fallback: cek pola data berpetik
    for (let k of keys) {
        const v = String(row[k] || "");
        if (v.startsWith("'") || v.includes("'") || v.includes('"')) return k;
    }

    return null;
}

/* =======================
   PERBANDINGAN DATA
======================= */

async function processComparison() {

    if (!fileLama.files[0] || !fileBaru.files[0]) {
        return alertMsg("Harap upload kedua file.");
    }

    const lama = await readExcel(fileLama.files[0]);
    const baru = await readExcel(fileBaru.files[0]);

    if (!lama || !baru) return;

    const kolom = detectKolomPIB(lama[0]);
    if (!kolom) return alertMsg("Kolom PIB tidak ditemukan.");

    const lamaPIB = lama.map(r => cleanPIB(r[kolom]));
    const baruPIB = baru.map(r => cleanPIB(r[kolom]));

    let hasil = baru.filter(r => !lamaPIB.includes(cleanPIB(r[kolom])));

    hasil = hasil.map(r => { r[kolom] = cleanPIB(r[kolom]); return r; });

    document.getElementById("resultCompare").style.display = "block";
    document.getElementById("resultCompare").innerHTML = `
        <b>Jumlah Data Lama:</b> ${lama.length}<br>
        <b>Jumlah Data Baru:</b> ${baru.length}<br>
        <b>Data Baru Ditemukan:</b> ${hasil.length}<br>
    `;

    if (hasil.length > 0) {
        const ws = XLSX.utils.json_to_sheet(hasil);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DATA_BARU");
        XLSX.writeFile(wb, "DATA_BARU_SAJA.xlsx");
    }
}

/* =======================
   PEMBERSIH PETIK PIB
======================= */

async function processCleaner() {

    if (!fileClean.files[0]) {
        return alertMsg("Harap upload file.");
    }

    const data = await readExcel(fileClean.files[0]);
    if (!data) return;

    const kolom = detectKolomPIB(data[0]);
    if (!kolom) return alertMsg("Kolom PIB tidak ditemukan.");

    data.forEach(r => r[kolom] = cleanPIB(r[kolom]));

    document.getElementById("resultClean").style.display = "block";
    document.getElementById("resultClean").innerHTML =
        "File berhasil dibersihkan. Download akan dimulai.";

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "BERSIH");
    XLSX.writeFile(wb, "PIB_TANPA_PETIK.xlsx");
}

/* =======================
   LABEL UPDATE
======================= */

fileLama.onchange = e => labelLama.innerText = e.target.files[0].name;
fileBaru.onchange = e => labelBaru.innerText = e.target.files[0].name;
fileClean.onchange = e => labelClean.innerText = e.target.files[0].name;

</script>

</body>
</html>
