<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Aplikasi Pengecekan & Pembersihan PIB</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
    body { margin:0; font-family:Arial,sans-serif; background:#e9f5ef; }
    header { background:#1faa59; padding:18px; color:white; text-align:center; font-size:22px; font-weight:bold; }
    .nav { display:flex; justify-content:center; background:#c6e9d2; padding:15px 0; gap:20px; flex-wrap:wrap; }
    .nav button { padding:10px 25px; border-radius:12px; border:none; background:#1faa59; color:white; cursor:pointer; transition:.2s; }
    .nav button.active, .nav button:hover { background:#0e8a47; }
    .container { max-width:900px; margin:25px auto; background:white; padding:30px; border-radius:18px; box-shadow:0 4px 15px rgba(0,0,0,.1); }
    h2 { text-align:center; margin-bottom:20px; color:#0e3c20; }

    .info-box {
        background:#fff8d6;
        border-left:5px solid #e6b800;
        padding:15px 18px;
        border-radius:10px;
        margin-bottom:22px;
        font-size:14px;
        color:#664d00;
    }
    .info-box ul { margin:8px 0 0 20px; }

    .file-group { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px; }
    .upload-box { flex:1; min-width:260px; border:2px dashed #9ccbb1; padding:20px; text-align:center; background:#f1f8f4; border-radius:12px; cursor:pointer; }
    input[type=file]{ display:none; }
    .btn { background:#1faa59; color:white; padding:12px 25px; border:none; border-radius:12px; font-size:16px; cursor:pointer; display:block; margin:15px auto 0; }
    .btn:hover { background:#0e8a47; }
    .result-box { display:none; margin-top:20px; background:#dff6e4; padding:18px; border-left:5px solid #1faa59; border-radius:12px; }

    .alertBox { position:fixed; left:50%; top:40%; transform:translate(-50%,-50%); background:white;
                padding:25px; border-radius:14px; width:320px; text-align:center; display:none;
                box-shadow:0 0 20px rgba(0,0,0,.25); z-index:1000;}
    .alertBox button { background:#ff3b30; color:white; padding:8px 22px; border:none; border-radius:10px; cursor:pointer; }
</style>
</head>

<body>

<header>Aplikasi Pengecekan & Pembersihan PIB</header>

<div class="nav">
    <button id="btnCompare" class="active" onclick="showPage('compare')">Perbandingan Data</button>
    <button id="btnClean" onclick="showPage('clean')">Pembersih Petik PIB</button>
</div>

<div id="pageCompare" class="container">
    <h2>Perbandingan Data Lama vs Baru</h2>

    <!-- INFO BOX SYARAT FILE -->
    <div class="info-box">
        <b>Persyaratan Penggunaan:</b>
        <ul>
            <li>Gunakan file Excel berekstensi <b>.xlsx</b> (bukan .xls atau .csv).</li>
            <li>Kolom PIB harus berisi angka minimal <b>6 digit</b>.</li>
            <li>Pastikan tidak ada <b>merge cell</b> pada baris header atau kolom PIB.</li>
            <li>Pastikan file tidak dikunci password.</li>
        </ul>
    </div>

    <div class="file-group">
        <label class="upload-box">
            <b>Upload Data Lama</b><br>
            <span id="labelLama">Belum ada file</span>
            <input type="file" id="fileLama" accept=".xlsx">
        </label>

        <label class="upload-box">
            <b>Upload Data Baru</b><br>
            <span id="labelBaru">Belum ada file</span>
            <input type="file" id="fileBaru" accept=".xlsx">
        </label>
    </div>

    <button class="btn" onclick="processComparison()">Proses Perbandingan</button>

    <div id="resultCompare" class="result-box"></div>
</div>

<div id="pageClean" class="container" style="display:none;">
    <h2>Pembersih Petik (') dan (") pada Kolom PIB</h2>

    <div class="file-group">
        <label class="upload-box">
            <b>Upload File Excel</b><br>
            <span id="labelClean">Belum ada file</span>
            <input type="file" id="fileClean" accept=".xlsx">
        </label>
    </div>

    <button class="btn" onclick="processCleaner()">Bersihkan Petik</button>

    <div id="resultClean" class="result-box"></div>
</div>

<div id="alertBox" class="alertBox">
    <div id="alertMsg"></div>
    <button onclick="closeAlert()">Tutup</button>
</div>

<script>

/* ==========================================================================
   HELPER / CLEAN PIB
   ========================================================================== */

function cleanPIB(x){
    return String(x||"")
        .replace(/['"]/g,"")
        .replace(/\s+/g,"")
        .trim();
}

function normalizeHeaderName(h){
    return String(h||"").toUpperCase().replace(/[^A-Z0-9]/g,"");
}

/* ==========================================================================
   DETEKSI HEADER
   ========================================================================== */

function findHeaderAndPIBColumn(raw){
    if(!raw || !raw.length) return null;
    const maxCheck = Math.min(25, raw.length);

    for(let r=0;r<maxCheck;r++){
        for(let c=0;c<raw[r].length;c++){
            if(normalizeHeaderName(raw[r][c]) === "NOPIB"){
                return { headerRow:r, col:c, name:raw[r][c] };
            }
        }
    }

    for(let r=0;r<maxCheck;r++){
        for(let c=0;c<raw[r].length;c++){
            if(normalizeHeaderName(raw[r][c]).includes("PIB")){
                return { headerRow:r, col:c, name:raw[r][c] };
            }
        }
    }

    return null;
}

/* ==========================================================================
   DETEKSI KOLOM PIB DARI ISI
   ========================================================================== */

function detectPIBColumnByContent(raw){
    if(!raw || raw.length===0) return -1;
    const rows = raw.length;
    const cols = Math.max(...raw.map(r=>r.length));
    const pattern = /^"?\d{6,}"?$/;

    let best=-1, scoreBest=0;
    for(let c=0;c<cols;c++){
        let score=0;
        for(let r=0;r<rows;r++){
            const v = String(raw[r][c]||"").trim();
            if(pattern.test(v)) score++;
        }
        if(score > scoreBest && score >= 3){
            scoreBest = score;
            best=c;
        }
    }
    return best;
}

/* ==========================================================================
   EXTRACT VALID PIB
   ========================================================================== */

function extractValidPIBFromMatrix(raw, col){
    const valid = [];
    const pattern = /^\d{6,}$/;
    for(let r=0;r<raw.length;r++){
        const v = cleanPIB(raw[r][col] || "");
        if(pattern.test(v)) valid.push(v);
    }
    return valid;
}

/* ==========================================================================
   READ EXCEL
   ========================================================================== */

async function readAsAOA(file){
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf);
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const raw = XLSX.utils.sheet_to_json(sheet,{header:1,defval:""});
    return { wb, sheet, raw };
}

/* ==========================================================================
   PEMBERSIH PETIK PIB
   ========================================================================== */

async function processCleaner(){
    const file = fileClean.files[0];
    if(!file) return alertMsg("Harap upload file.");

    const { raw } = await readAsAOA(file);

    const det = findHeaderAndPIBColumn(raw);
    let col = -1;

    if(det){
        col = det.col;
    } else {
        col = detectPIBColumnByContent(raw);
        if(col === -1) return alertMsg("Kolom PIB tidak ditemukan.");
    }

    for(let r=0; r<raw.length; r++){
        raw[r][col] = cleanPIB(raw[r][col]);
    }

    const ws = XLSX.utils.aoa_to_sheet(raw);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "BERSIH");

    XLSX.writeFile(wb, "PIB_TANPA_PETIK.xlsx");

    resultClean.style.display="block";
    resultClean.innerHTML="File berhasil dibersihkan. Struktur tidak berubah.";
}

/* ==========================================================================
   PERBANDINGAN DATA + ALERT DATA BARU = 0
   ========================================================================== */

async function processComparison(){
    const fLama = fileLama.files[0];
    const fBaru = fileBaru.files[0];
    if(!fLama || !fBaru) return alertMsg("Harap upload kedua file.");

    const lama = await readAsAOA(fLama);
    const baru = await readAsAOA(fBaru);

    let dLama = findHeaderAndPIBColumn(lama.raw);
    let idxLama = dLama ? dLama.col : detectPIBColumnByContent(lama.raw);
    if(idxLama === -1) return alertMsg("Kolom PIB tidak ditemukan di DATA LAMA.");

    let dBaru = findHeaderAndPIBColumn(baru.raw);
    let idxBaru = dBaru ? dBaru.col : detectPIBColumnByContent(baru.raw);
    if(idxBaru === -1) return alertMsg("Kolom PIB tidak ditemukan di DATA BARU.");

    const lamaVals = new Set(extractValidPIBFromMatrix(lama.raw, idxLama));

    const hasil = [];
    for(let r=0;r<baru.raw.length;r++){
        const v = cleanPIB(baru.raw[r][idxBaru] || "");
        if(/^\d{6,}$/.test(v) && !lamaVals.has(v)){
            const rowCopy = [...baru.raw[r]];
            rowCopy[idxBaru] = v;
            hasil.push(rowCopy);
        }
    }

    resultCompare.style.display="block";
    resultCompare.innerHTML = `
        <b>Jumlah Data Lama:</b> ${lama.raw.length}<br>
        <b>Jumlah Data Baru:</b> ${baru.raw.length}<br>
        <b>Data Baru:</b> ${hasil.length}<br>
    `;

    // ============================
    //  ALERT DATA BARU = 0
    // ============================
    if(hasil.length === 0){
        alertMsg("Tidak ada data baru yang berbeda. (Data Baru = 0)");
        return;
    }

    // Jika ada data baru â†’ download
    const ws = XLSX.utils.aoa_to_sheet(hasil);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "BARU");
    XLSX.writeFile(wb, "DATA_BARU_SAJA.xlsx");
}

/* ==========================================================================
   UI HANDLERS
   ========================================================================== */

function alertMsg(msg){
    alertBox.style.display="block";
    alertMsg.innerText = msg;
}

function closeAlert(){
    alertBox.style.display="none";
}

function showPage(p){
    pageCompare.style.display = (p==="compare")?"block":"none";
    pageClean.style.display   = (p==="clean")?"block":"none";
    btnCompare.classList.toggle("active", p==="compare");
    btnClean.classList.toggle("active", p==="clean");
}

fileLama.onchange = e => labelLama.innerText = e.target.files[0]?.name || "Belum ada file";
fileBaru.onchange = e => labelBaru.innerText = e.target.files[0]?.name || "Belum ada file";
fileClean.onchange = e => labelClean.innerText = e.target.files[0]?.name || "Belum ada file";

</script>

</body>
</html>
