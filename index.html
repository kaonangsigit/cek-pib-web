<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Aplikasi Pengecekan & Pembersihan PIB</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
    body { margin:0; font-family:Arial,sans-serif; background:#e9f5ef; }
    header { background:#1faa59; padding:18px; color:white; text-align:center; font-size:22px; font-weight:bold; }
    .nav { display:flex; justify-content:center; background:#c6e9d2; padding:15px 0; gap:20px; flex-wrap:wrap; }
    .nav button { padding:10px 25px; border-radius:12px; border:none; background:#1faa59; color:white; cursor:pointer; transition:.2s; }
    .nav button.active, .nav button:hover { background:#0e8a47; }
    .container { max-width:900px; margin:25px auto; background:white; padding:30px; border-radius:18px; box-shadow:0 4px 15px rgba(0,0,0,.1); }
    h2 { text-align:center; margin-bottom:25px; color:#0e3c20; }
    .file-group { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:20px; }
    .upload-box { flex:1; min-width:260px; border:2px dashed #9ccbb1; padding:20px; text-align:center; background:#f1f8f4; border-radius:12px; cursor:pointer; }
    input[type=file]{ display:none; }
    .btn { background:#1faa59; color:white; padding:12px 25px; border:none; border-radius:12px; font-size:16px; cursor:pointer; display:block; margin:15px auto 0; }
    .btn:hover { background:#0e8a47; }
    .result-box { display:none; margin-top:20px; background:#dff6e4; padding:18px; border-left:5px solid #1faa59; border-radius:12px; }
    .alertBox { position:fixed; left:50%; top:40%; transform:translate(-50%,-50%); background:white;
                padding:25px; border-radius:14px; width:320px; text-align:center; display:none;
                box-shadow:0 0 20px rgba(0,0,0,.25); z-index:1000;}
    .alertBox button { background:#ff3b30; color:white; padding:8px 22px; border:none; border-radius:10px; cursor:pointer; }
</style>
</head>

<body>

<header>Aplikasi Pengecekan & Pembersihan PIB</header>

<div class="nav">
    <button id="btnCompare" class="active" onclick="showPage('compare')">Perbandingan Data</button>
    <button id="btnClean" onclick="showPage('clean')">Pembersih Petik PIB</button>
</div>

<div id="pageCompare" class="container">
    <h2>Perbandingan Data Lama vs Baru</h2>

    <div class="file-group">
        <label class="upload-box">
            <b>Upload Data Lama</b><br>
            <span id="labelLama">Belum ada file</span>
            <input type="file" id="fileLama" accept=".xlsx">
        </label>

        <label class="upload-box">
            <b>Upload Data Baru</b><br>
            <span id="labelBaru">Belum ada file</span>
            <input type="file" id="fileBaru" accept=".xlsx">
        </label>
    </div>

    <button class="btn" onclick="processComparison()">Proses Perbandingan</button>

    <div id="resultCompare" class="result-box"></div>
</div>

<div id="pageClean" class="container" style="display:none;">
    <h2>Pembersih Petik (') dan (") pada Kolom PIB</h2>

    <div class="file-group">
        <label class="upload-box">
            <b>Upload File Excel</b><br>
            <span id="labelClean">Belum ada file</span>
            <input type="file" id="fileClean" accept=".xlsx">
        </label>
    </div>

    <button class="btn" onclick="processCleaner()">Bersihkan Petik</button>

    <div id="resultClean" class="result-box"></div>
</div>

<div id="alertBox" class="alertBox">
    <div id="alertMsg"></div>
    <button onclick="closeAlert()">Tutup</button>
</div>

<script>
/* ====================================================== */
/* UI/ALERT */
/* ====================================================== */
function alertMsg(msg){
    document.getElementById("alertMsg").innerText = msg;
    document.getElementById("alertBox").style.display = "block";
}
function closeAlert(){ document.getElementById("alertBox").style.display="none"; }

function showPage(p){
    pageCompare.style.display = (p==="compare") ? "block" : "none";
    pageClean.style.display = (p==="clean") ? "block" : "none";

    btnCompare.classList.toggle("active", p==="compare");
    btnClean.classList.toggle("active", p==="clean");
}

/* ====================================================== */
/* UTIL / CLEANING */
/* ====================================================== */
function cleanPIB(x){
    return String(x||"").replace(/['"]/g,"").replace(/\s+/g,"").trim();
}

/* ====================================================== */
/* SMART READER (AMAN) */
/* ====================================================== */
async function readExcel(file){
    const buf = await file.arrayBuffer();
    const wb  = XLSX.read(buf);
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const raw = XLSX.utils.sheet_to_json(sheet,{header:1,defval:""});

    // DETEKSI HEADER (baris yang ada NO_PIB / PIB)
    let headerRow = -1;
    for(let r=0;r<Math.min(raw.length,20);r++){
        const upper = raw[r].map(v=>String(v).toUpperCase());
        if(upper.some(v=>v.includes("PIB"))) { headerRow=r; break; }
    }

    if(headerRow >=0){
        const data = XLSX.utils.sheet_to_json(sheet,{header:1,range:headerRow,defval:""});
        const headers = data.shift();
        const rowsObj = data.map(row=>{
            let o={};
            headers.forEach((h,i)=>o[h]=row[i]);
            return o;
        });
        return {mode:"header", sheet, raw, headers, dataObj:rowsObj};
    }

    // fallback no-header
    return {mode:"no-header", sheet, raw};
}

/* ====================================================== */
/* DETEKSI KOLOM PIB */
/* ====================================================== */
function detectPIBColumnByHeader(rowObj){
    const keys = Object.keys(rowObj);
    for(let k of keys){
        let norm = k.toUpperCase().replace(/[^A-Z0-9]/g,"");
        if(norm.includes("PIB")) return k;
        if(norm.includes("NOPIB")||norm.includes("NOMORPIB")) return k;
    }
    return null;
}

function detectPIBColumnByContent(raw){
    const rows = raw.length;
    const cols = Math.max(...raw.map(r=>r.length));
    const pattern = /^"?\d{6,}"?$/;

    let best=-1, scoreBest=0;
    for(let c=0;c<cols;c++){
        let score=0, nonempty=0;
        for(let r=0;r<rows;r++){
            const v = String(raw[r][c]||"").trim();
            if(v!=="") nonempty++;
            if(pattern.test(v)) score++;
        }
        if(score>=3 && score>scoreBest){
            scoreBest=score; best=c;
        }
    }
    return best;
}

/* ====================================================== */
/* CLEANER â€” AMAN (CELL-BY-CELL) */
/* ====================================================== */
function cleanSheetPIB(sheet, pibCol){
    const range = XLSX.utils.decode_range(sheet["!ref"]);
    for(let R=range.s.r; R<=range.e.r; R++){
        const cellRef = XLSX.utils.encode_cell({r:R,c:pibCol});
        const cell = sheet[cellRef];
        if(cell && typeof cell.v === "string"){
            cell.v = cleanPIB(cell.v);
            cell.t = "s";
        }
    }
}

/* ====================================================== */
/* PENGHILANG PETIK */
/* ====================================================== */
async function processCleaner(){
    const file = fileClean.files[0];
    if(!file) return alertMsg("Harap upload file.");

    const read = await readExcel(file);

    if(read.mode==="header"){
        const sheet = read.sheet;
        const kolom = detectPIBColumnByHeader(read.dataObj[0]);
        if(!kolom) return alertMsg("Kolom PIB tidak ditemukan.");

        // cari index kolom PIB
        const idx = read.headers.indexOf(kolom);
        if(idx === -1) return alertMsg("Index kolom PIB tidak valid.");

        cleanSheetPIB(sheet, idx);

    } else {
        // no-header
        const idx = detectPIBColumnByContent(read.raw);
        if(idx === -1) return alertMsg("Kolom PIB tidak ditemukan dari isi.");
        cleanSheetPIB(read.sheet, idx);
    }

    XLSX.writeFile(read.sheet, "PIB_TANPA_PETIK.xlsx");
    resultClean.style.display="block";
    resultClean.innerHTML="File berhasil dibersihkan (struktur aman).";
}

/* ====================================================== */
/* PERBANDINGAN DATA (AMAN) */
/* ====================================================== */
async function processComparison(){
    const fLama = fileLama.files[0];
    const fBaru = fileBaru.files[0];
    if(!fLama || !fBaru) return alertMsg("Harap upload kedua file.");

    const lama = await readExcel(fLama);
    const baru = await readExcel(fBaru);

    /* ==== HEADER MODE ==== */
    if(lama.mode==="header" && baru.mode==="header"){
        const kolom = detectPIBColumnByHeader(lama.dataObj[0]);
        if(!kolom) return alertMsg("Kolom PIB tidak ditemukan.");

        const lamaSet = new Set(lama.dataObj.map(r=>cleanPIB(r[kolom])));

        const hasil = baru.dataObj.filter(r=>{
            const v = cleanPIB(r[kolom]);
            return v && !lamaSet.has(v);
        });

        resultCompare.style.display="block";
        resultCompare.innerHTML = `
            <b>Jumlah Data Lama:</b> ${lama.dataObj.length}<br>
            <b>Jumlah Data Baru:</b> ${baru.dataObj.length}<br>
            <b>Data Baru:</b> ${hasil.length}<br>
        `;

        if(hasil.length>0){
            const ws = XLSX.utils.json_to_sheet(hasil);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,"BARU");
            XLSX.writeFile(wb,"DATA_BARU_SAJA.xlsx");
        }

        return;
    }

    /* ==== NO-HEADER MODE ==== */
    const lamaPIBidx = detectPIBColumnByContent(lama.raw);
    const baruPIBidx = detectPIBColumnByContent(baru.raw);
    const idx = (baruPIBidx !== -1) ? baruPIBidx : lamaPIBidx;

    if(idx === -1) return alertMsg("Kolom PIB tidak ditemukan dari isi file.");

    const lamaVals = new Set(lama.raw.map(r=>cleanPIB(r[idx])));
    const hasilRows = baru.raw.filter(r=>{
        const v = cleanPIB(r[idx]);
        return v && !lamaVals.has(v);
    });

    resultCompare.style.display="block";
    resultCompare.innerHTML = `
        <b>Jumlah Data Lama (baris):</b> ${lama.raw.length}<br>
        <b>Jumlah Data Baru (baris):</b> ${baru.raw.length}<br>
        <b>Data Baru (baris):</b> ${hasilRows.length}<br>
    `;

    if(hasilRows.length>0){
        const ws = XLSX.utils.aoa_to_sheet(hasilRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,"BARU");
        XLSX.writeFile(wb,"DATA_BARU_SAJA.xlsx");
    }
}

/* LABEL UPDATES */
fileLama.onchange = e=>labelLama.innerText = e.target.files[0]?.name || "Belum ada file";
fileBaru.onchange = e=>labelBaru.innerText = e.target.files[0]?.name || "Belum ada file";
fileClean.onchange = e=>labelClean.innerText = e.target.files[0]?.name || "Belum ada file";

</script>

</body>
</html>
