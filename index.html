<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Cek & Bersihkan PIB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #eef7f2;
        color: #222;
    }

    .navbar {
        background: #32b87c;
        padding: 18px;
        text-align: center;
        color: white;
        font-size: 22px;
        font-weight: bold;
        letter-spacing: 0.4px;
    }

    .tabs {
        display: flex;
        justify-content: center;
        background: #dff4eb;
        padding: 12px;
        gap: 12px;
    }

    .tab {
        padding: 12px 25px;
        cursor: pointer;
        background: #ccefe0;
        border-radius: 10px;
        font-weight: bold;
        transition: 0.25s;
    }
    .tab:hover { background: #b7e7d3; }

    .tab.active {
        background: #32b87c;
        color: white;
    }

    .container {
        max-width: 900px;
        margin: 30px auto;
        padding: 25px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* GRID UPLOAD */
    .upload-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    @media(max-width: 700px) {
        .upload-grid {
            grid-template-columns: 1fr;
        }
    }

    .file-card {
        border: 2px dashed #9ddfcb;
        padding: 18px;
        border-radius: 12px;
        background: #f5fffb;
        cursor: pointer;
        text-align: center;
        font-size: 16px;
        transition: 0.25s;
    }

    .file-card:hover {
        background: #ecfdf7;
    }

    input[type="file"] { display: none; }

    .btn {
        padding: 14px 24px;
        background: #32b87c;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 15px;
        display: block;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
        transition: 0.25s;
    }
    .btn:hover {
        background: #289b68;
    }

    .result {
        margin-top: 20px;
        padding: 18px;
        background: #e2f7ee;
        border-left: 6px solid #32b87c;
        border-radius: 8px;
        display: none;
    }

    .alert {
        background: white;
        padding: 22px;
        position: fixed;
        left: 50%;
        top: 40%;
        transform: translate(-50%, -50%);
        border-radius: 12px;
        box-shadow: 0 5px 18px rgba(0,0,0,0.25);
        display: none;
        z-index: 999;
        font-size: 18px;
        text-align: center;
    }

    .alert button {
        margin-top: 12px;
        padding: 8px 20px;
        background: #ff4d4d;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
    }
</style>
</head>

<body>

<div class="navbar">Aplikasi Pengecekan & Pembersihan PIB</div>

<!-- Tabs -->
<div class="tabs">
    <div class="tab active" onclick="showTab('compare')">Perbandingan Data</div>
    <div class="tab" onclick="showTab('clean')">Pembersih Petik PIB</div>
</div>

<!-- ======================= TAB 1 ======================= -->
<div id="compare" class="container">
    <h2>Perbandingan Data Lama vs Baru</h2>

    <div class="upload-grid">
        <label class="file-card">
            <b>Upload Data Lama</b><br><br>
            <span id="labelLama">Belum ada file</span>
            <input type="file" id="fileLama" accept=".xlsx">
        </label>

        <label class="file-card">
            <b>Upload Data Baru</b><br><br>
            <span id="labelBaru">Belum ada file</span>
            <input type="file" id="fileBaru" accept=".xlsx">
        </label>
    </div>

    <button class="btn" onclick="processCompare()">Proses Perbandingan</button>

    <div id="resultCompare" class="result"></div>
</div>

<!-- ======================= TAB 2 ======================= -->
<div id="clean" class="container" style="display:none">
    <h2>Pembersih Petik Kolom PIB</h2>

    <div class="upload-grid">
        <label class="file-card">
            <b>Upload File Excel</b><br><br>
            <span id="labelClean">Belum ada file</span>
            <input type="file" id="fileClean" accept=".xlsx">
        </label>
    </div>

    <button class="btn" onclick="processClean()">Bersihkan Petik</button>

    <div id="resultClean" class="result"></div>
</div>

<!-- ALERT -->
<div id="alertBox" class="alert">
    <span id="alertMsg"></span><br>
    <button onclick="closeAlert()">Tutup</button>
</div>

<script>
function alertShow(msg) {
    document.getElementById("alertMsg").innerText = msg;
    document.getElementById("alertBox").style.display = "block";
}
function closeAlert() {
    document.getElementById("alertBox").style.display = "none";
}

function showTab(tab) {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add("active");

    document.getElementById("compare").style.display = "none";
    document.getElementById("clean").style.display = "none";
    document.getElementById(tab).style.display = "block";
}

/* =============== CLEAN PIB ================== */
function cleanPIBValue(v) {
    return String(v || "").replace(/['"]/g, "").trim();
}

function detectPIBColumn(row) {
    const keys = Object.keys(row);
    for (let k of keys) {
        const name = k.toUpperCase();
        if (name.includes("NO") && name.includes("PIB")) return k;
        if (name === "PIB") return k;
    }
    for (let k of keys) {
        if (String(row[k]).includes('"') || String(row[k]).includes("'")) return k;
    }
    return null;
}

/* ================ CLEAN FEATURE ================= */
async function processClean() {
    const file = document.getElementById("fileClean").files[0];
    if (!file) return alertShow("Silakan upload file!");

    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const sheet = wb.Sheets[wb.SheetNames[0]];
    let rows = XLSX.utils.sheet_to_json(sheet, { raw: false });

    let pibCol = detectPIBColumn(rows[0]);
    if (!pibCol) return alertShow("Kolom PIB tidak ditemukan!");

    rows = rows.map(r => {
        r[pibCol] = cleanPIBValue(r[pibCol]);
        return r;
    });

    const ws = XLSX.utils.json_to_sheet(rows);
    const newWb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(newWb, ws, "Bersih");
    XLSX.writeFile(newWb, "PIB_BERSIH.xlsx");

    document.getElementById("resultClean").innerHTML =
        `<b>File berhasil dibersihkan!</b><br>Kolom PIB terdeteksi: ${pibCol}`;
    document.getElementById("resultClean").style.display = "block";
}

/* =============== COMPARE FEATURE ================= */
async function readExcel(file) {
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const sheet = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(sheet, { raw: false });
}

async function processCompare() {
    const lama = document.getElementById("fileLama").files[0];
    const baru = document.getElementById("fileBaru").files[0];

    if (!lama || !baru) return alertShow("Upload kedua file!");

    const dataLama = await readExcel(lama);
    const dataBaru = await readExcel(baru);

    const pibCol = detectPIBColumn(dataLama[0]);
    if (!pibCol) return alertShow("Kolom PIB tidak ditemukan!");

    let lamaPIB = dataLama.map(r => cleanPIBValue(r[pibCol]));
    let baruPIB = dataBaru.map(r => cleanPIBValue(r[pibCol]));

    let baruOnly = dataBaru.filter(r => !lamaPIB.includes(cleanPIBValue(r[pibCol])));

    document.getElementById("resultCompare").innerHTML =
        `<b>Kolom PIB:</b> ${pibCol}<br>
         <b>Jumlah Data Lama:</b> ${lamaPIB.length}<br>
         <b>Jumlah Data Baru:</b> ${baruPIB.length}<br>
         <b>Data Baru yang Tidak Ada di Data Lama:</b> ${baruOnly.length}`;
    document.getElementById("resultCompare").style.display = "block";

    if (baruOnly.length > 0) {
        const ws = XLSX.utils.json_to_sheet(baruOnly);
        const newWb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWb, ws, "DATA_BARU");
        XLSX.writeFile(newWb, "DATA_BARU_SAJA.xlsx");
    }
}

/* LABEL UPDATE */
document.getElementById("fileLama").addEventListener("change", e => {
    document.getElementById("labelLama").innerText = e.target.files[0].name;
});
document.getElementById("fileBaru").addEventListener("change", e => {
    document.getElementById("labelBaru").innerText = e.target.files[0].name;
});
document.getElementById("fileClean").addEventListener("change", e => {
    document.getElementById("labelClean").innerText = e.target.files[0].name;
});
</script>

</body>
</html>
