<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Aplikasi Pengecekan & Pembersihan PIB</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #e9f5ef;
    }

    header {
        background: #1faa59;
        padding: 18px;
        text-align: center;
        font-size: 22px;
        font-weight: bold;
        color: white;
    }

    .nav {
        display: flex;
        justify-content: center;
        background: #c6e9d2;
        padding: 15px 0;
        gap: 20px;
        flex-wrap: wrap;
    }

    .nav button {
        padding: 10px 25px;
        border-radius: 12px;
        border: none;
        background: #1faa59;
        color: white;
        font-size: 15px;
        cursor: pointer;
        transition: 0.3s;
    }

    .nav button.active {
        background: #0e8a47;
    }

    .nav button:hover {
        background: #0e8a47;
    }

    .container {
        max-width: 900px;
        margin: 25px auto;
        background: white;
        padding: 30px;
        border-radius: 18px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    h2 {
        text-align: center;
        margin-bottom: 25px;
        color: #0e3c20;
    }

    .file-group {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 20px;
        width: 100%;
        margin-bottom: 20px;
    }

    .upload-box {
        flex: 1;
        min-width: 260px;
        border: 2px dashed #9ccbb1;
        padding: 20px;
        text-align: center;
        background: #f1f8f4;
        border-radius: 12px;
        cursor: pointer;
    }

    input[type=file] { display: none; }

    .btn {
        background: #1faa59;
        color: white;
        padding: 12px 25px;
        border-radius: 12px;
        border: none;
        font-size: 16px;
        cursor: pointer;
        display: block;
        margin: 15px auto 0 auto;
    }

    .btn:hover {
        background: #0e8a47;
    }

    .result-box {
        display: none;
        margin-top: 20px;
        padding: 18px;
        background: #dff6e4;
        border-left: 5px solid #1faa59;
        border-radius: 12px;
    }

    .alertBox {
        position: fixed;
        left: 50%;
        top: 40%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 25px;
        border-radius: 14px;
        width: 300px;
        text-align: center;
        display: none;
        box-shadow: 0 0 20px rgba(0,0,0,0.25);
        z-index: 1000;
    }

    .alertBox button {
        background: #ff3b30;
        color: white;
        padding: 8px 22px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        margin-top: 10px;
    }
</style>
</head>

<body>

<header>Aplikasi Pengecekan & Pembersihan PIB</header>

<div class="nav">
    <button id="btnCompare" class="active" onclick="showPage('compare')">Perbandingan Data</button>
    <button id="btnClean" onclick="showPage('clean')">Pembersih Petik PIB</button>
</div>

<div id="pageCompare" class="container">
    <h2>Perbandingan Data Lama vs Baru</h2>

    <div class="file-group">
        <label class="upload-box">
            <b>Upload Data Lama</b><br>
            <span id="labelLama">Belum ada file</span>
            <input type="file" id="fileLama" accept=".xlsx">
        </label>

        <label class="upload-box">
            <b>Upload Data Baru</b><br>
            <span id="labelBaru">Belum ada file</span>
            <input type="file" id="fileBaru" accept=".xlsx">
        </label>
    </div>

    <button class="btn" onclick="processComparison()">Proses Perbandingan</button>
    <div id="resultCompare" class="result-box"></div>
</div>

<div id="pageClean" class="container" style="display:none;">
    <h2>Pembersih Petik (') dan (") untuk Kolom PIB</h2>

    <div class="file-group">
        <label class="upload-box">
            <b>Upload File Excel</b><br>
            <span id="labelClean">Belum ada file</span>
            <input type="file" id="fileClean" accept=".xlsx">
        </label>
    </div>

    <button class="btn" onclick="processCleaner()">Bersihkan Petik</button>
    <div id="resultClean" class="result-box"></div>
</div>

<div id="alertBox" class="alertBox">
    <div id="alertMsg"></div>
    <button onclick="closeAlert()">Tutup</button>
</div>

<script>

/* ========================
       ALERT SYSTEM
======================== */
function alertMsg(msg) {
    document.getElementById("alertMsg").innerText = msg;
    document.getElementById("alertBox").style.display = "block";
}
function closeAlert() {
    document.getElementById("alertBox").style.display = "none";
}

/* ========================
     PAGE SWITCH
======================== */
function showPage(p) {
    document.getElementById("pageCompare").style.display = (p === 'compare') ? "block" : "none";
    document.getElementById("pageClean").style.display = (p === 'clean') ? "block" : "none";

    document.getElementById("btnCompare").classList.toggle("active", p === 'compare');
    document.getElementById("btnClean").classList.toggle("active", p === 'clean');
}

/* ========================
     CLEAN PIB VALUE
======================== */
function cleanPIB(x) {
    return String(x || "")
        .replace(/['"]/g, "")
        .replace(/\s+/g, "")
        .trim();
}

/* =====================================================
   DETEKSI HEADER OTOMATIS (PERSIS SEPERTI COLAB)
===================================================== */
function detectHeaderRow(sheetRange) {
    for (let r = 0; r < sheetRange.length; r++) {
        const row = sheetRange[r].map(v => String(v || "").toUpperCase());
        if (row.some(v => v.includes("NO. PIB"))) return r;
    }
    for (let r = 0; r < sheetRange.length; r++) {
        const row = sheetRange[r].map(v => String(v || "").toUpperCase());
        if (row.some(v => v.includes("PIB"))) return r;
    }
    return 0;
}

/* =====================================================
   READ EXCEL DENGAN HEADER DINAMIS (super penting!)
===================================================== */
async function readExcelDynamicHeader(file) {
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf);

    const sheet = wb.Sheets[wb.SheetNames[0]];
    const raw = XLSX.utils.sheet_to_json(sheet, {
        header: 1,
        defval: ""
    });

    const headerRowIdx = detectHeaderRow(raw);
    const data = XLSX.utils.sheet_to_json(sheet, {
        header: 1,
        range: headerRowIdx,
        defval: ""
    });

    const headers = data.shift();
    return data.map(row => {
        let obj = {};
        headers.forEach((h, i) => obj[h] = row[i]);
        return obj;
    });
}

/* ========================
   DETEKSI KOLOM PIB
======================== */
function detectKolomPIB(row) {
    const keys = Object.keys(row);
    for (let k of keys) {
        const n = k.toUpperCase().replace(/[^A-Z0-9]/g, "");
        if (n.includes("PIB")) return k;
    }
    for (let k of keys) {
        const n = k.toUpperCase().replace(/[^A-Z0-9]/g, "");
        if (n.includes("NOPIB") || n.includes("NOMORPIB")) return k;
    }
    return null;
}

/* ========================
  PROSES PERBANDINGAN
======================== */
async function processComparison() {
    const fLama = fileLama.files[0];
    const fBaru = fileBaru.files[0];

    if (!fLama || !fBaru)
        return alertMsg("Harap upload kedua file.");

    const lama = await readExcelDynamicHeader(fLama);
    const baru = await readExcelDynamicHeader(fBaru);

    const kolom = detectKolomPIB(lama[0]);
    if (!kolom)
        return alertMsg("Kolom PIB tidak ditemukan di file lama.");

    const lamaPIB = lama.map(r => cleanPIB(r[kolom]));
    const baruPIB = baru.map(r => cleanPIB(r[kolom]));

    let hasil = baru.filter(r => !lamaPIB.includes(cleanPIB(r[kolom])));

    hasil = hasil.map(r => {
        let copy = {...r};
        copy[kolom] = cleanPIB(copy[kolom]);
        return copy;
    });

    document.getElementById("resultCompare").style
.display = "block";
    document.getElementById("resultCompare").innerHTML = `
        <b>Jumlah Data Lama:</b> ${lama.length}<br>
        <b>Jumlah Data Baru:</b> ${baru.length}<br>
        <b>Data Baru:</b> ${hasil.length}<br>
    `;

    if (hasil.length > 0) {
        const ws = XLSX.utils.json_to_sheet(hasil);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "BARU");
        XLSX.writeFile(wb, "DATA_BARU_SAJA.xlsx");
    }
}

/* ========================
  PEMBERSIH PETIK
======================== */
async function processCleaner() {
    const file = fileClean.files[0];
    if (!file)
        return alertMsg("Harap upload file.");

    const data = await readExcelDynamicHeader(file);
    const kolom = detectKolomPIB(data[0]);

    if (!kolom)
        return alertMsg("Kolom PIB tidak ditemukan.");

    const cleaned = data.map(r => {
        let copy = {...r};
        copy[kolom] = cleanPIB(copy[kolom]);
        return copy;
    });

    document.getElementById("resultClean").style.display = "block";
    document.getElementById("resultClean").innerHTML = "File berhasil dibersihkan.";

    const ws = XLSX.utils.json_to_sheet(cleaned);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "BERSIH");
    XLSX.writeFile(wb, "PIB_TANPA_PETIK.xlsx");
}

/* ========================
      LABEL UPDATE
======================== */
fileLama.addEventListener("change", e => labelLama.innerText = e.target.files[0]?.name || "Belum ada file");
fileBaru.addEventListener("change", e => labelBaru.innerText = e.target.files[0]?.name || "Belum ada file");
fileClean.addEventListener("change", e => labelClean.innerText = e.target.files[0]?.name || "Belum ada file");

</script>

</body>
</html>
